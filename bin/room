#!/usr/bin/bash

bankmode=
minmode=

while getopts "s:t:ahb:m" opt; do
    case $opt in
        h)
            cat <<EOF >&2
Usage: $0 [ -s starter ] [ -t tv-type ] [ -a ]

-t TV type: NTSC, PAL, SECAM
-s Starter: Airex, Dirtex, Aquax, Demo, NoSave
-a for AtariAge builds
EOF
            exit 2;
            ;;
        a)
            atariage=AA.
            ;;
        b)
            bankmode=$OPTARG
            ;;
        m)
            minmode=1
            ;;
        s)
            case $OPTARG in
                Airex)
                    starter=Airex;
                    ;;
                Dirtex)
                    starter=Dirtex;
                    ;;
                Aquax)
                    starter=Aquax;
                    ;;
                Demo)
                    starter=Demo;
                    ;;
                AA)
                    starter=AA.$starter;
                    ;;
                NoSave)
                    starter=NoSave;
                    ;;
            esac
            ;;
        t)
            case $OPTARG in
                PAL)
                    tv=PAL;
                    ;;
                NTSC)
                    tv=NTSC;
                    ;;
                SECAM)
                    tv=SECAM;
                    ;;
            esac
            ;;
    esac
done

if [ "$minmode" = "1" ]; then
    for bank in 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f; do
        min=4096
        mincfg='???'
        for starter in AA.Aquax AA.Dirtex AA.Airex Aquax Dirtex Airex Demo NoSave ; do
            for tv in NTSC PAL SECAM; do
                rm -f Object/Bank$bank.$starter.$tv.o
                size=$(make Object/Bank$bank.$starter.$tv.o -f Source/Generated/Makefile 2>&1 \
                           | grep 'bytes left' | grep -v %d | cut -d: -f5 | cut -d ' ' -f 8)
                if [ "x$size" = "x" ]; then
                    # no op
                    echo -n ;
                elif [ $size -lt $min ]; then
                    min=$size
                    mincfg="$starter for $tv"
                fi
            done
        done
        echo "bank $bank min is $min bytes free in $mincfg"
    done
    exit 0
fi

if [ "x$bankmode" != "x" ]; then
    bank=$(printf %02x $bankmode)
    for starter in AA.Aquax AA.Dirtex AA.Airex Aquax Dirtex Airex Demo NoSave ; do
        for tv in NTSC PAL SECAM; do
            rm -f Object/Bank$bank.$starter.$tv.o
            echo "$starter.$tv:"
            make Object/Bank$bank.$starter.$tv.o -f Source/Generated/Makefile 2>&1 \
                | grep 'bytes left' | grep -v %d | cut -d: -f5
        done
    done
    exit 0
fi

if [ "x$starter" = "x" ]; then
    starter=Airex
fi

if [ "x$tv" = "x" ]; then
    tv=PAL
fi

if [ "x$atariage" = "x" ]; then
    aa=public
else
    aa='AtariAge official'
fi

echo "Space remanining in $starter $aa build for $tv:"

for bank in 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f; do
    rm -f Object/Bank$bank.$atariage$starter.$tv.o
    make Object/Bank$bank.$atariage$starter.$tv.o -f Source/Generated/Makefile 2>&1 \
        | grep 'bytes left' | grep -v %d | cut -d: -f5
done
